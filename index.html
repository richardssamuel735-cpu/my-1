<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Accident Detection Dashboard — Prototype</title>
  <!-- Leaflet for map -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha384-sA+qgk8k5bFZ2YQd0r7q8sM6F2j0j1c6ZPdV1g6qZrVZ2zqGZfT4vQm1v3QGx1zG" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    :root{--accent:#ef4444;--muted:#6b7280}
    body{font-family:Inter,ui-sans-serif,system-ui,Arial;margin:0;background:#f4f6f8;color:#111}
    .topbar{background:#fff;padding:12px 18px;display:flex;align-items:center;gap:12px;border-bottom:1px solid #e6e9ee}
    .logo{font-weight:700;color:var(--accent)}
    .container{display:grid;grid-template-columns:420px 1fr;gap:12px;padding:12px;height:calc(100vh - 56px)}
    .card{background:#fff;border-radius:10px;padding:12px;box-shadow:0 4px 18px rgba(16,24,40,0.06);overflow:auto}
    #map{width:100%;height:100%;border-radius:10px}
    .section{margin-bottom:12px}
    button{background:var(--accent);color:#fff;border:none;padding:8px 10px;border-radius:8px;cursor:pointer}
    .muted{color:var(--muted);font-size:13px}
    .list-item{padding:8px 6px;border-bottom:1px dashed #eee}
    .row{display:flex;gap:8px;align-items:center}
    input,select{padding:8px;border-radius:8px;border:1px solid #ddd}
    .small{font-size:13px}
    .danger{background:#b91c1c} html, body, .container, .card, #map {
  height: 100%;
  margin: 0;
  padding: 0;
}

  </style>
</head>
<body>
  <div class="topbar">
    <div class="logo">Accident Dashboard (Prototype)</div>
    <div class="muted">Hospital & doctor info • Live location • Motion detect • Auto-alert</div>
  </div>
  <div class="container">
    <div class="card" style="display:flex;flex-direction:column">
      <div class="section">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <strong>Controls</strong>
          <div class="muted small">Prototype — connect real server for production</div>
        </div>
        <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
          <button id="locBtn">Get Live Location</button>
          <button id="startRec">Start Video/Audio Record</button>
          <button id="stopRec" disabled>Stop & Save Record</button>
          <button id="call108">Call Emergency (108)</button>
          <button id="shareWa">Share via WhatsApp</button>
          <button id="connectBT">Connect Bluetooth</button>
        </div>
      </div>

      <div class="section">
        <strong>Incident log</strong>
        <div id="log" style="max-height:260px;overflow:auto;margin-top:8px"></div>
      </div>

      <div class="section">
        <strong>Nearby hospitals (sample)</strong>
        <div id="hospitals" style="max-height:220px;overflow:auto;margin-top:8px"></div>
      </div>
      <div class="section">
  <div id="speedStatus">Speed: -- km/h</div>
  <div id="engineStatus">Engine: --</div>
</div>        
      <div class="section">
  <div id="speedStatus">Speed: -- km/h</div>
  <div id="engineStatus">Engine: --</div>
</div>



      <div class="section">
        <strong>Settings</strong>
        <div style="display:flex;gap:8px;margin-top:8px;align-items:center">
          <label class="small">Alert radius (meters)</label>
          <input id="radius" type="number" value="5" style="width:100px"/>
        </div>
        <div style="display:flex;gap:8px;margin-top:8px;align-items:center">
          <label class="small">Motion threshold (g)</label>
          <input id="threshold" type="number" value="2" step="0.1" style="width:100px"/>
        </div>
      </div>

      <div class="section">
        <strong>Raw JSON payload (what will be sent to emergency services)</strong>
        <pre id="payload" style="background:#f8fafc;padding:8px;border-radius:8px;max-height:140px;overflow:auto"></pre>
      </div>
    </div>

    <div class="card">
      <div id="map"></div>
    </div>
  </div>

  <script>
    /*************************************************************************
     * Prototype dashboard implementing requested features.
     * Important notes (read before using):
     * - This is a client-side prototype only. Auto-calling, SMS or sending
     *   alerts to police/hospitals requires a backend service or third-party
     *   APIs with proper authentication and consent.
     * - Web Bluetooth cannot broadcast messages to arbitrary phones. It can
     *   only connect to Bluetooth devices that advertise known GATT services.
     * - For production you must implement server endpoints like /api/alert
     *   to relay messages to authorities, use SMS gateways (Twilio/MSG91),
     *   and comply with privacy laws.
     *************************************************************************/

    // --- Map setup (Leaflet)
    const map = L.map('map').setView([22.5937,78.9629],5); // center India
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
      maxZoom: 18,
      attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    let myMarker = null;
    let incidentMarker = null;
    let currentPos = null;

    function addLog(text){
      const d = new Date().toLocaleString();
      const el = document.createElement('div');
      el.className='list-item';
      el.innerHTML = `<div class=\"row\"><div><strong>\${d}</strong></div></div><div class=\"muted small\">\${text}</div>`;
      document.getElementById('log').prepend(el);
    }

    // Haversine distance (meters)
    function distanceMeters(lat1,lon1,lat2,lon2){
      function toRad(x){return x*Math.PI/180}
      const R=6371000;
      const dLat=toRad(lat2-lat1), dLon=toRad(lon2-lon1);
      const a=Math.sin(dLat/2)*Math.sin(dLat/2)+Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)*Math.sin(dLon/2);
      const c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
      return R*c;
    }

    // Sample nearby hospitals (in real app fetch from server or Places API)
    const sampleHospitals = [
      {name:'Apollo Hospitals',lat:17.4452,lon:78.3498,specialist:'Emergency Medicine',phone:'+914066000000'},
      {name:'KIMS Hospital',lat:17.4360,lon:78.4490,specialist:'Trauma',phone:'+914066111111'},
      {name:'Government General Hospital',lat:17.4446,lon:78.3714,specialist:'Multi-speciality',phone:'+914066222222'}
    ];

    function renderHospitals(){
      const cont = document.getElementById('hospitals'); cont.innerHTML='';
      for(const h of sampleHospitals){
        const el = document.createElement('div'); el.className='list-item';
        let dist = currentPos ? Math.round(distanceMeters(currentPos.lat,currentPos.lon,h.lat,h.lon)) + ' m' : '—';
        el.innerHTML = `<div style=\"display:flex;justify-content:space-between\"><strong>${h.name}</strong><span class=\"muted small\">${dist}</span></div><div class=\"small muted\">${h.specialist} • ${h.phone}</div>`;
        cont.appendChild(el);
      }
    }

    // Live geolocation
    document.getElementById('locBtn').addEventListener('click', async ()=>{
      if(!navigator.geolocation) return addLog('Geolocation not supported');
      navigator.geolocation.getCurrentPosition(pos=>{
        const {latitude,longitude} = pos.coords;
        currentPos = {lat:latitude,lon:longitude};
        if(myMarker) myMarker.setLatLng([latitude,longitude]); else myMarker = L.marker([latitude,longitude]).addTo(map).bindPopup('You are here').openPopup();
        map.setView([latitude,longitude],15);
        addLog('Live location updated');
        renderHospitals();
        updatePayload();
      },err=>addLog('Geolocation error: '+err.message));
    });

    // Share via WhatsApp (open share with location)
    document.getElementById('shareWa').addEventListener('click', ()=>{
      if(!currentPos) return addLog('Get location first');
      const text = `Emergency! Accident at https://www.openstreetmap.org/?mlat=${currentPos.lat}&mlon=${currentPos.lon} \nPlease send help.`;
      const url = `https://wa.me/?text=${encodeURIComponent(text)}`;
      window.open(url,'_blank');
      addLog('Opened WhatsApp share');
    });

    // Call emergency
    document.getElementById('call108').addEventListener('click', ()=>{
      // this will attempt to open phone dialer on supported devices
      window.location.href = 'tel:108';
      addLog('Dialer opened for 108');
    });

    // --- Audio & Video recording (MediaRecorder)
    let mediaRecorder = null; let recordedChunks = [];
    const startRecBtn = document.getElementById('startRec');
    const stopRecBtn = document.getElementById('stopRec');
    if (mediaRecorder && mediaRecorder.state === "recording") {
  mediaRecorder.stop();
} else {
  addLog('Cannot stop; recorder is not active.');
}


    startRecBtn.addEventListener('click', async ()=>{
      try{
        const stream = await navigator.mediaDevices.getUserMedia({audio:true,video:true});
        mediaRecorder = new MediaRecorder(stream);
        recordedChunks = [];
        mediaRecorder.ondataavailable = e => { if(e.data.size>0) recordedChunks.push(e.data); };
        mediaRecorder.onstop = ()=>{
          const blob = new Blob(recordedChunks,{type:'video/webm'});
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a'); a.href=url; a.download='incident.webm'; a.textContent='Download recording';
          const container = document.getElementById('log'); const node=document.createElement('div'); node.className='list-item'; node.appendChild(a); container.prepend(node);
          addLog('Recording saved locally (client-side). Consider uploading to server.');
        };
        mediaRecorder.start();
        startRecBtn.disabled=true; stopRecBtn.disabled=false; addLog('Recording started');
      }catch(e){addLog('Media access denied or not available: '+e.message)}
    });

    stopRecBtn.addEventListener('click', ()=>{
      if(mediaRecorder) mediaRecorder.stop(); startRecBtn.disabled=false; stopRecBtn.disabled=true;
    });

    // --- Web Bluetooth (basic connect flow)
    document.getElementById('connectBT').addEventListener('click', async ()=>{
      if(!navigator.bluetooth) return addLog('Web Bluetooth not supported in this browser');
      try{
        const device = await navigator.bluetooth.requestDevice({acceptAllDevices:true});
        addLog('Bluetooth device selected: '+device.name || device.id);
        // Production: connect to known GATT services
      }catch(e){addLog('Bluetooth error: '+e.message)}
    });

    // --- Motion detection (DeviceMotion)
    let motionArmed = true; // always on in this prototype
    if(window.DeviceMotionEvent){
      window.addEventListener('devicemotion', (ev)=>{
        // compute simple acceleration magnitude
        const acc = ev.accelerationIncludingGravity; if(!acc) return;
        const ax = acc.x||0, ay = acc.y||0, az = acc.z||0;
        const mag = Math.sqrt(ax*ax+ay*ay+az*az);
        const thresh = parseFloat(document.getElementById('threshold').value) || 2;
        if(motionArmed && mag>thresh){
          onAccidentDetected('High acceleration detected (g~'+mag.toFixed(2)+')');
          motionArmed=false; // avoid repeated alerts; in prod use cooldown logic
          setTimeout(()=>motionArmed=true,15000);
        }
      });
    } else addLog('DeviceMotion not supported');
    let prevPos = null;
let prevTime = null;
window.addEventListener('devicemotion', ev => {
  const { x = 0, y = 0, z = 0 } = ev.accelerationIncludingGravity || {};
  const mag = Math.sqrt(x*x + y*y + z*z);
  const moving = mag > (parseFloat(document.getElementById('threshold').value) || 2);
  document.getElementById('engineStatus').textContent = moving ? 'Engine: Moving' : 'Engine: Idle';
});

navigator.geolocation.watchPosition(pos => {
  const now = Date.now();
  if (prevPos && prevTime) {
    const d = distanceMeters(prevPos.lat, prevPos.lon, pos.coords.latitude, pos.coords.longitude);
    const dt = (now - prevTime) / 1000;
    const speedKmh = (d / dt) * 3.6;
    document.getElementById('speedStatus').textContent = `Speed: ${speedKmh.toFixed(1)} km/h`;
  }
  prevPos = { lat: pos.coords.latitude, lon: pos.coords.longitude };
  prevTime = now;
});


    // Accident handler
    function updatePayload(){
      const payload = {
        timestamp: new Date().toISOString(),
        location: currentPos || null,
        incidentType: 'possible_collision',
        nearbyHospitals: sampleHospitals.map(h=>({name:h.name,phone:h.phone,dist_m: currentPos ? Math.round(distanceMeters(currentPos.lat,currentPos.lon,h.lat,h.lon)) : null}))
      };
      document.getElementById('payload').textContent = JSON.stringify(payload,null,2);
      return payload;
    }

    function onAccidentDetected(reason){
      addLog('ACCIDENT TRIGGERED: '+reason);
      // mark on map
      if(currentPos){
        if(incidentMarker) incidentMarker.setLatLng([currentPos.lat,currentPos.lon]); else incidentMarker = L.circle([currentPos.lat,currentPos.lon],{radius:20,color:'red'}).addTo(map).bindPopup('Incident detected').openPopup();
      }

      // create payload
      const payload = updatePayload();

      // Simulate broadcasting to nearby users (5m radius)
      const rad = parseFloat(document.getElementById('radius').value) || 5;
      addLog('Simulated: broadcasting alert to devices within '+rad+' meters (requires network or peer devices in production).');

      // Auto-call/dial to emergency numbers (opens dialer)
      // NOTE: Browsers will block direct calls; window.location.href = 'tel:' opens dialer on mobile
      setTimeout(()=>{
        // open dialer to first hospital phone as demonstration
        if(sampleHospitals[0]){
          addLog('Opening dialer to nearest hospital: '+sampleHospitals[0].phone);
          // window.location.href = 'tel:'+sampleHospitals[0].phone; // uncomment to enable
        }
      },500);

      // Send alert to server (placeholder)
      // In production, POST to your server which then relays SMS/calls/WhatsApp/Control room
      fetch('/api/alert',{
        method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)
      }).then(r=>addLog('Sent alert to server (placeholder endpoint /api/alert)')).catch(e=>addLog('Failed to send to server (no backend in prototype)'));

      // Update UI
      addLog('Payload prepared — shown in JSON box. Consider uploading recordings and attaching images.');
    }

    // --- Auto demo: try to get initial location on load (best-effort)
    window.addEventListener('load', ()=>{
      if(navigator.geolocation) navigator.geolocation.getCurrentPosition(pos=>{ currentPos={lat:pos.coords.latitude,lon:pos.coords.longitude}; if(myMarker) myMarker.setLatLng([currentPos.lat,currentPos.lon]); else myMarker=L.marker([currentPos.lat,currentPos.lon]).addTo(map).bindPopup('You are here'); map.setView([currentPos.lat,currentPos.lon],13); renderHospitals(); updatePayload(); }, ()=>{});
    });

    // For testing: button to simulate accident
    const simBtn = document.createElement('button'); simBtn.textContent='Simulate Accident'; simBtn.style.background='#f59e0b'; simBtn.addEventListener('click', ()=>onAccidentDetected('Manual simulation'));
    document.querySelector('.topbar').appendChild(simBtn);

    // expose small API for debugging
    window.__dashboard = {onAccidentDetected,updatePayload,distanceMeters};

  </script>
</body>
</html>
